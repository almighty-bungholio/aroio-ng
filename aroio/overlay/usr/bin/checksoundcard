#!/bin/sh

. /boot/userconfig.txt

CONFIG="/boot/config.txt"
ALSACONFIG="/etc/modprobe.d/alsa-base.conf"

[ "$DISPLAY_ROTATE" = "ON" ] && DISPLAY_ROTATE="display_rotate=1" || DISPLAY_ROTATE=""

case $SOUNDCARD in
	'Internal HDMI audio')
	if ! grep -q HDMI_AUDIO "$CONFIG"
	then
		cardmount rw
		echo "userconfig and config.txt have different entries for soundcards,"
		echo "backing up and writing a new config.txt..."
		cp "$CONFIG" "$CONFIG"_bak
		cat <<-EOF > "$CONFIG"
			$DISPLAY_ROTATE
			force_turbo=1
			dtdebug=1
			max_usb_current=1
			disable_splash=1
			kernel=zImage
			dtoverlay=i2s-mmap
			dtparam=audio=on #HDMI_AUDIO
			hdmi_drive=2 #HDMI_AUDIO
			dtoverlay=lirc-rpi,gpio_in_pin=25
			disable_overscan=1
			dtoverlay=pi3-disable-wifi
			dtoverlay=pi3-disable-bt
		EOF

		if ! mount | grep -q mmcblk0p2
		then 	echo "initramfs rootfs.cpio" >> "$CONFIG"
		fi
		
		cardmount ro
		reboot
	fi
	# Taking care of correct soundcard order
	sed -i '/options snd slots/c\options snd slots=snd_bcm2835' "$ALSACONFIG"
	;;



	'Internal audio jack')
	if ! grep -q ONBOARD_AUDIO "$CONFIG"
	then
		cardmount rw
		echo "userconfig and config.txt have different entries for soundcards,"
		echo "backing up and writing a new config.txt..."
		cp "$CONFIG" "$CONFIG"_bak
		cat <<-EOF > "$CONFIG"
			$DISPLAY_ROTATE
			force_turbo=1
			dtdebug=1
			max_usb_current=1
			disable_splash=1
			kernel=zImage
			dtoverlay=i2s-mmap
			dtparam=audio=on #ONBOARD_AUDIO
			dtoverlay=lirc-rpi,gpio_in_pin=25
			disable_overscan=1
			dtoverlay=pi3-disable-wifi
			dtoverlay=pi3-disable-bt
		EOF

		if ! mount | grep -q mmcblk0p2
		then 	echo "initramfs rootfs.cpio" >> "$CONFIG"
		fi
		cardmount ro
		reboot
	fi
	# Taking care of correct soundcard order
	sed -i '/options snd slots/c\options snd slots=snd_bcm2835' "$ALSACONFIG"
	;;


	'JustBoom DAC')
	if ! grep -q justboom-dac "$CONFIG"
	then
		cardmount rw
		echo "userconfig and config.txt have different entries for soundcards,"
		echo "backing up and writing a new config.txt..."
		cp "$CONFIG" "$CONFIG"_bak
		cat <<-EOF > "$CONFIG"
			$DISPLAY_ROTATE
			force_turbo=1
			dtdebug=1
			max_usb_current=1
			disable_splash=1
			kernel=zImage
			dtoverlay=i2s-mmap
			dtoverlay=justboom-dac
			dtoverlay=lirc-rpi,gpio_in_pin=25
			disable_overscan=1
			dtoverlay=pi3-disable-wifi
			dtoverlay=pi3-disable-bt
		EOF

		if ! mount | grep -q mmcblk0p2
		then 	echo "initramfs rootfs.cpio" >> "$CONFIG"
		fi
		cardmount ro
		reboot
	fi
	# Taking care of correct soundcard order
	sed -i '/options snd slots/c\options snd slots=snd_soc_justboom_dac' "$ALSACONFIG"
	;;


	'Aroio DAC')
	if ! grep -q aroiodac "$CONFIG"
	then
		cardmount rw
		echo "userconfig and config.txt have different entries for soundcards,"
		echo "backing up and writing a new config.txt..."
		cp "$CONFIG" "$CONFIG"_bak
		cat <<-EOF > "$CONFIG"
			$DISPLAY_ROTATE
			force_turbo=1
			dtdebug=1
			max_usb_current=1
			disable_splash=1
			kernel=zImage
			dtoverlay=i2s-mmap
			dtoverlay=aroiodac
			dtoverlay=lirc-rpi,gpio_in_pin=25
			disable_overscan=1
			dtoverlay=pi3-disable-wifi
			dtoverlay=pi3-disable-bt
		EOF

		if ! mount | grep -q mmcblk0p2
		then 	echo "initramfs rootfs.cpio" >> "$CONFIG"
		fi
		cardmount ro
		reboot
	fi
	# Taking care of correct soundcard order
	sed -i '/options snd slots/c\options snd slots=snd_soc_aroiodac' "$ALSACONFIG"
	;;



	'IQAudIO DAC')
	if ! grep -q iqaudio-dac "$CONFIG"
	then
		cardmount rw
		echo "userconfig and config.txt have different entries for soundcards,"
		echo "backing up and writing a new config.txt..."
		cp "$CONFIG" "$CONFIG"_bak
		cat <<-EOF > "$CONFIG"
			$DISPLAY_ROTATE
			force_turbo=1
			dtdebug=1
			max_usb_current=1
			disable_splash=1
			kernel=zImage
			dtoverlay=i2s-mmap
			dtoverlay=iqaudio-dac
			dtoverlay=lirc-rpi,gpio_in_pin=25
			disable_overscan=1
			dtoverlay=pi3-disable-wifi
			dtoverlay=pi3-disable-bt
		EOF

		if ! mount | grep -q mmcblk0p2
		then 	echo "initramfs rootfs.cpio" >> "$CONFIG"
		fi
		cardmount ro
		reboot
	fi
	# Taking care of correct soundcard order
	sed -i '/options snd slots/c\options snd slots=snd_soc_iqaudio_dac' "$ALSACONFIG"
	;;


	'HiFiBerry DAC')
	if ! grep -q hifiberry-dac "$CONFIG"
	then
		cardmount rw
		echo "userconfig and config.txt have different entries for soundcards,"
		echo "backing up and writing a new config.txt..."
		cp "$CONFIG" "$CONFIG"-bak
		cat <<-EOF > "$CONFIG"
			$DISPLAY_ROTATE
			force_turbo=1
			dtdebug=1
			max_usb_current=1
			disable_splash=1
			kernel=zImage
			dtparam=i2c_arm=on
			dtoverlay=i2s-mmap
			dtoverlay=hifiberry-dac
			dtparam=spi=on
			dtoverlay=lirc-rpi,gpio_in_pin=25
			disable_overscan=1
			dtoverlay=pi3-disable-wifi
			dtoverlay=pi3-disable-bt
		EOF

		if ! mount | grep -q mmcblk0p2
		then	echo "initramfs rootfs.cpio" >> "$CONFIG"
		fi
		cardmount ro
		reboot
	fi
	# Taking care of correct soundcard order
	sed -i '/options snd slots/c\options snd slots=snd_soc_hifiberry_dac' "$ALSACONFIG"
	;;


	'HiFiBerry DAC+'|'AroioDAC')
	echo "HiFiberry DAC+"
	if ! grep -q hifiberry-dacplus "$CONFIG"
	then
		cardmount rw
		echo "userconfig and config.txt have different entries for soundcards,"
		echo "backing up and writing a new config.txt..."
		cp "$CONFIG" "$CONFIG"-bak
		cat <<-EOF > "$CONFIG"
			$DISPLAY_ROTATE
			force_turbo=1
			dtdebug=1
			max_usb_current=1
			disable_splash=1
			kernel=zImage
			dtparam=i2c_arm=on
			dtoverlay=i2s-mmap
			dtoverlay=hifiberry-dacplus
			dtparam=spi=on
			dtoverlay=lirc-rpi,gpio_in_pin=25
			disable_overscan=1
			dtoverlay=pi3-disable-wifi
			dtoverlay=pi3-disable-bt
		EOF

		if ! mount | grep -q mmcblk0p2
		then	echo "initramfs rootfs.cpio" >> "$CONFIG"
		fi
		cardmount ro
		reboot
	fi
	# Taking care of correct soundcard order
	sed -i '/options snd slots/c\options snd slots=snd_soc_hifiberry_dacplus' "$ALSACONFIG"
	;;


	'HiFiBerry DAC')
	echo "HiFiberry DAC"
	if ! grep -q hifiberry-dac "$CONFIG"
	then
		cardmount rw
		echo "userconfig and config.txt have different entries for soundcards,"
		echo "backing up and writing a new config.txt..."
		cp "$CONFIG" "$CONFIG"-bak
		cat <<-EOF > "$CONFIG"
			$DISPLAY_ROTATE
			force_turbo=1
			dtdebug=1
			max_usb_current=1
			disable_splash=1
			kernel=zImage
			dtparam=i2c_arm=on
			dtoverlay=i2s-mmap
			dtoverlay=hifiberry-dac
			dtparam=spi=on
			dtoverlay=lirc-rpi,gpio_in_pin=25
			disable_overscan=1
			dtoverlay=pi3-disable-wifi
			dtoverlay=pi3-disable-bt
		EOF

		if ! mount | grep -q mmcblk0p2
		then	echo "initramfs rootfs.cpio" >> "$CONFIG"
		fi
		cardmount ro
		reboot
	fi
	# Taking care of correct soundcard order
	sed -i '/options snd slots/c\options snd slots=snd_soc_hifiberry_dac' "$ALSACONFIG"
	;;


	'HiFiBerry Digi')
	echo "HiFiBerry Digi"
	if ! grep -q hifiberry-digi "$CONFIG"
	then
		cardmount rw
		echo "userconfig and config.txt have different entries for soundcards,"
		echo "backing up and writing a new config.txt..."
		cp "$CONFIG" "$CONFIG"-bak
		cat <<-EOF > "$CONFIG"
			$DISPLAY_ROTATE
			force_turbo=1
			dtdebug=1
			max_usb_current=1
			disable_splash=1
			kernel=zImage
			dtoverlay=i2s-mmap
			dtoverlay=hifiberry-digi
			dtoverlay=lirc-rpi,gpio_in_pin=25
			disable_overscan=1
			dtoverlay=pi3-disable-wifi
			dtoverlay=pi3-disable-bt
		EOF

	if ! mount | grep -q mmcblk0p2
	then	echo "initramfs rootfs.cpio" >> "$CONFIG"
	fi
	cardmount ro
	reboot
	fi
	# Taking care of correct soundcard order
	sed -i '/options snd slots/c\options snd slots=snd_soc_hifiberry_digi' "$ALSACONFIG"
	;;


	'Allo Piano DAC')
	if ! grep -q allo-piano-dac-pcm512x-audio "$CONFIG"
	then
		cardmount rw
		echo "userconfig and config.txt have different entries for soundcards,"
		echo "backing up and writing a new config.txt..."
		cp "$CONFIG" "$CONFIG"_bak
		cat <<-EOF > "$CONFIG"
			$DISPLAY_ROTATE
			force_turbo=1
			dtdebug=1
			max_usb_current=1
			disable_splash=1
			kernel=zImage
			dtoverlay=i2s-mmap
			dtoverlay=allo-piano-dac-pcm512x-audio
			dtoverlay=lirc-rpi,gpio_in_pin=25
			disable_overscan=1
			dtoverlay=pi3-disable-wifi
			dtoverlay=pi3-disable-bt
		EOF

		if ! mount | grep -q mmcblk0p2
		then 	echo "initramfs rootfs.cpio" >> "$CONFIG"
		fi
		cardmount ro
		reboot
	fi
	# Taking care of correct soundcard order
	sed -i '/options snd slots/c\options snd slots=snd_soc_allo_piano_dac' "$ALSACONFIG"
	;;


	'Allo Piano 2.1 DAC')
	if ! grep -q allo-piano-dac-plus-pcm512x-audio "$CONFIG"
	then
		cardmount rw
		echo "userconfig and config.txt have different entries for soundcards,"
		echo "backing up and writing a new config.txt..."
		cp "$CONFIG" "$CONFIG"_bak
		cat <<-EOF > "$CONFIG"
			$DISPLAY_ROTATE
			force_turbo=1
			dtdebug=1
			max_usb_current=1
			disable_splash=1
			kernel=zImage
			dtoverlay=i2s-mmap
			dtoverlay=allo-piano-dac-plus-pcm512x-audio
			dtoverlay=lirc-rpi,gpio_in_pin=25
			disable_overscan=1
			dtoverlay=pi3-disable-wifi
			dtoverlay=pi3-disable-bt
		EOF

		if ! mount | grep -q mmcblk0p2
		then 	echo "initramfs rootfs.cpio" >> "$CONFIG"
		fi
		cardmount ro
		reboot
	fi
	# Taking care of correct soundcard order
	sed -i '/options snd slots/c\options snd slots=snd_soc_allo_piano_dacplus' "$ALSACONFIG"
	;;


	'Allo Boss DAC')
	if ! grep -q allo-boss-dac-pcm512x-audio "$CONFIG"
	then
		cardmount rw
		echo "userconfig and config.txt have different entries for soundcards,"
		echo "backing up and writing a new config.txt..."
		cp "$CONFIG" "$CONFIG"_bak
		cat <<-EOF > "$CONFIG"
			$DISPLAY_ROTATE
			force_turbo=1
			dtdebug=1
			max_usb_current=1
			disable_splash=1
			kernel=zImage
			dtoverlay=i2s-mmap
			dtoverlay=allo-boss-dac-pcm512x-audio
			dtoverlay=lirc-rpi,gpio_in_pin=25
			disable_overscan=1
			dtoverlay=pi3-disable-wifi
			dtoverlay=pi3-disable-bt
		EOF

		if ! mount | grep -q mmcblk0p2
		then 	echo "initramfs rootfs.cpio" >> "$CONFIG"
		fi
		cardmount ro
		reboot
	fi
	# Taking care of correct soundcard order
	sed -i '/options snd slots/c\options snd slots=snd_soc_allo_boss_dac' "$ALSACONFIG"
	;;


	'Allo DigiOne')
	if ! grep -q allo-digione "$CONFIG"
	then
		cardmount rw
		echo "userconfig and config.txt have different entries for soundcards,"
		echo "backing up and writing a new config.txt..."
		cp "$CONFIG" "$CONFIG"_bak
		cat <<-EOF > "$CONFIG"
			$DISPLAY_ROTATE
			force_turbo=1
			dtdebug=1
			max_usb_current=1
			disable_splash=1
			kernel=zImage
			dtoverlay=i2s-mmap
			dtoverlay=allo-digione
			dtoverlay=lirc-rpi,gpio_in_pin=25
			disable_overscan=1
			dtoverlay=pi3-disable-wifi
			dtoverlay=pi3-disable-bt
		EOF

		if ! mount | grep -q mmcblk0p2
		then 	echo "initramfs rootfs.cpio" >> "$CONFIG"
		fi
		cardmount ro
		reboot
	fi
	# Taking care of correct soundcard order
	sed -i '/options snd slots/c\options snd slots=snd_soc_allo_digione' "$ALSACONFIG"
	;;


	'M-Audio Fast Track Pro')
	if ! grep -q "#fasttrack_pro" "$CONFIG"
	then
		cardmount rw
		echo "userconfig and config.txt have different entries for soundcards,"
		echo "backing up and writing a new config.txt..."
		cp "$CONFIG" "$CONFIG"-bak
		cat <<-EOF > "$CONFIG"
			$DISPLAY_ROTATE
			force_turbo=1
			dtdebug=1
			max_usb_current=1
			disable_splash=1
			kernel=zImage
			disable_overscan=1
			dtoverlay=lirc-rpi,gpio_in_pin=25
			#fasttrack_pro
			dtoverlay=pi3-disable-wifi
			dtoverlay=pi3-disable-bt
		EOF

		if ! mount | grep -q mmcblk0p2
		then	echo "initramfs rootfs.cpio" >> "$CONFIG"
		fi
		cardmount ro
		reboot
	fi
	# Taking care of correct soundcard order
	sed -i '/options snd slots/c\options snd slots=snd_usb_audio' "$ALSACONFIG"
	;;


	'Focusrite Scarlett')
	if ! grep -q "#fr_scarlett" "$CONFIG"
	then
		cardmount rw
		echo "userconfig and config.txt have different entries for soundcards,"
		echo "backing up and writing a new config.txt..."
		cp "$CONFIG" "$CONFIG"-bak
		cat <<-EOF > "$CONFIG"
			$DISPLAY_ROTATE
			force_turbo=1
			dtdebug=1
			max_usb_current=1
			disable_splash=1
			kernel=zImage
			disable_overscan=1
			dtoverlay=lirc-rpi,gpio_in_pin=25
			#fr_scarlett
			dtoverlay=pi3-disable-wifi
			dtoverlay=pi3-disable-bt
		EOF

		if ! mount | grep -q mmcblk0p2
		then	echo "initramfs rootfs.cpio" >> "$CONFIG"
		fi
		cardmount ro
		reboot
	fi
	# Taking care of correct soundcard order
	sed -i '/options snd slots/c\options snd slots=snd_usb_audio' "$ALSACONFIG"
	;;


	'NI Audio 8 DJ')
	if ! grep -q "#ni_audio8dj" "$CONFIG"
	then
		cardmount rw
		echo "userconfig and config.txt have different entries for soundcards,"
		echo "backing up and writing a new config.txt..."
		cp "$CONFIG" "$CONFIG"-bak
		cat <<-EOF > "$CONFIG"
			$DISPLAY_ROTATE
			force_turbo=1
			dtdebug=1
			max_usb_current=1
			disable_splash=1
			kernel=zImage
			disable_overscan=1
			dtoverlay=lirc-rpi,gpio_in_pin=25
			#ni_audio8dj
			dtoverlay=pi3-disable-wifi
			dtoverlay=pi3-disable-bt
		EOF

		if ! mount | grep -q mmcblk0p2
		then	echo "initramfs rootfs.cpio" >> "$CONFIG"
		fi
		cardmount ro
		reboot
	fi
	# Taking care of correct soundcard order
	sed -i '/options snd slots/c\options snd slots=snd_usb_audio' "$ALSACONFIG"
	;;


	'RME Fireface UCX')
	if ! grep -q "#fireface_ucx" "$CONFIG"
	then
		cardmount rw
		echo "userconfig and config.txt have different entries for soundcards,"
		echo "backing up and writing a new config.txt..."
		cp "$CONFIG" "$CONFIG"-bak
		cat <<-EOF > "$CONFIG"
			$DISPLAY_ROTATE
			force_turbo=1
			dtdebug=1
			max_usb_current=1
			disable_splash=1
			kernel=zImage
			disable_overscan=1
			dtoverlay=lirc-rpi,gpio_in_pin=25
			#fireface_ucx
			dtoverlay=pi3-disable-wifi
			dtoverlay=pi3-disable-bt
		EOF

		if ! mount | grep -q mmcblk0p2
		then	echo "initramfs rootfs.cpio" >> "$CONFIG"
		fi
		cardmount ro
		reboot
	fi
	# Taking care of correct soundcard order
	sed -i '/options snd slots/c\options snd slots=snd_usb_audio' "$ALSACONFIG"
	;;

	'Dr. DAC prime')
	if ! grep -q "#dr_dac_prime" "$CONFIG"
	then
		cardmount rw
		echo "userconfig and config.txt have different entries for soundcards,"
		echo "backing up and writing a new config.txt..."
		cp "$CONFIG" "$CONFIG"-bak
		cat <<-EOF > "$CONFIG"
			$DISPLAY_ROTATE
			force_turbo=1
			dtdebug=1
			max_usb_current=1
			disable_splash=1
			kernel=zImage
			disable_overscan=1
			dtoverlay=lirc-rpi,gpio_in_pin=25
			#dr_dac_prime
			dtoverlay=pi3-disable-wifi
			dtoverlay=pi3-disable-bt
		EOF

		if ! mount | grep -q mmcblk0p2
		then	echo "initramfs rootfs.cpio" >> "$CONFIG"
		fi
		cardmount ro
		reboot
	fi
	# Taking care of correct soundcard order
	sed -i '/options snd slots/c\options snd slots=snd_usb_audio' "$ALSACONFIG"
	;;

	'USB Class Compliant')
	if ! grep -q "#usb_class_compliant" "$CONFIG"
	then
		cardmount rw
		echo "userconfig and config.txt have different entries for soundcards,"
		echo "backing up and writing a new config.txt..."
		cp "$CONFIG" "$CONFIG"-bak
		cat <<-EOF > "$CONFIG"
			$DISPLAY_ROTATE
			force_turbo=1
			dtdebug=1
			max_usb_current=1
			disable_splash=1
			kernel=zImage
			disable_overscan=1
			dtoverlay=lirc-rpi,gpio_in_pin=25
			#usb_class_compliant
			dtoverlay=pi3-disable-wifi
			dtoverlay=pi3-disable-bt
		EOF

		if ! mount | grep -q mmcblk0p2
		then	echo "initramfs rootfs.cpio" >> "$CONFIG"
		fi
		cardmount ro
		reboot
	fi
	# Taking care of correct soundcard order
	sed -i '/options snd slots/c\options snd slots=snd_usb_audio' "$ALSACONFIG"
	;;


	'NOTAroioDAC')
	echo "AroioDAC!"
	if ! grep -q hifiberry-dacplus "$CONFIG"
	then
		cardmount rw
		echo "userconfig and config.txt have different entries for soundcards,"
		echo "backing up and writing a new config.txt..."
		cp "$CONFIG" "$CONFIG"-bak
		cat <<-EOF > "$CONFIG"
			$DISPLAY_ROTATE
			force_turbo=1
			dtdebug=1
			max_usb_current=1
			disable_splash=1
			kernel=zImage
			dtparam=i2c_arm=on
			dtoverlay=i2s-mmap
			dtoverlay=hifiberry-dacplus
			dtparam=spi=on
			dtoverlay=lirc-rpi,gpio_in_pin=25
			disable_overscan=1
			dtoverlay=pi3-disable-wifi
			dtoverlay=pi3-disable-bt
		EOF

		if ! mount | grep -q mmcblk0p2
		then	echo "initramfs rootfs.cpio" >> "$CONFIG"
		fi
		cardmount ro
		reboot
	fi
	;;

esac
