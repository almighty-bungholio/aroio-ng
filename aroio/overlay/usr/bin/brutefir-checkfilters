#!/bin/sh

. /boot/userconfig.txt

SDDIR='/boot/filter'
RAMDIR='/tmp/filter'

mkdir -p "$SDDIR"
mkdir -p "$RAMDIR"
cp -r "$SDDIR"/* "$RAMDIR"

# Mitgelieferte Filter bei Bedarf auspacken
[ "$LOAD_PREFILTER" = "ON" ] && /bin/zcat /etc/brutefir/filter.tgz | tar -xvf - -C /tmp
cardmount rw
rsync --exclude "*.tmp" -vrlt --delete "$RAMDIR"/ "$SDDIR"
cardmount ro

# Fälle:
# 1: Neues File im RAM -> nach SDKarte kopieren.
# 2: Gelöschtes File im RAM -> von SDKarte löschen

while (true)
do
    inotifywait -r -e modify,attrib,close_write,move,create,delete --exclude '\.tmp' "$RAMDIR"
    echo "Files changed in "$RAMDIR", will synchronize changes to "$SDDIR"..."
    cardmount rw
    rsync --exclude "*.tmp" -vrlt --delete "$RAMDIR"/ "$SDDIR"
    cardmount ro
done