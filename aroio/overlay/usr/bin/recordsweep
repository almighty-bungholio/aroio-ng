#!/bin/sh

. /boot/userconfig.txt

if ! lsusb | grep '2752:0007'
	then	echo '<img src="/no_mic.png" border="0" style="float: left; width: 32px; margin-right: 4px;"/>No Microphone connected, please connect a <a class="forward" href="https://www.abacus-electronics.de/produkte/streaming/raumkorrektur/minidsp-umik-1.html" title="UMIK-1 ABACUS-Shop" target="_blank">miniDSP UMIK-1</a>.<br>Kein Mikrofon angeschlossen, bitte schließen Sie ein <a class="forward" href="https://www.abacus-electronics.de/produkte/streaming/raumkorrektur/minidsp-umik-1.html" title="UMIK-1 ABACUS-Shop" target="_blank">miniDSP UMIK-1</a> an.<br>' && exit
	else	echo '<img src="/mic.gif" border="0" style="float: left; width: 32px; margin-right: 4px;"/>Microphone found, continuing with 200 sec measurement...<br>Mikrofon gefunden, Messung läuft...<br>'
fi

INFILE1='/boot/Logsweep/Start.wav'
INFILE2='/boot/Logsweep/Logsweep96.raw.7z'
INFILE3='/boot/Logsweep/End.wav'
OUTFILE='/tmp/Logsweep48_rec.raw'

cd /tmp
rm Logsweep48_rec*

echo '<b>Bitte beachten Sie, dass die Audiovero Clean! Funktion am Ger&auml;t entsprechend der Auswahl der Ausgabe eingestellt sein muss!
<br>Please make sure to set the Audiovero Clean! funktion on the device acording to the chosen output option!</b>'

if ! [ -e /tmp/Logsweep96.raw ]
then
	echo "Logsweep packed, unpacking it, this may take around 20 seconds, but only needs to be done once per boot..."
	7zr e  $INFILE2
else
	echo "Logsweep already unpacked, continuing..."
fi

touch /tmp/measurement

# $1 marks ms_coding (ms_on|ms_off)
# $2 marks measurement through convolver (control_on|control_off)
#[[ "$1" = "ms_off" && "$2" = "control_off"  ]] && AUDIO_OUTPUT="vol-plug" && controlaudio stop
#[[ "$1" = "ms_on"  && "$2" = "control_off"  ]] && AUDIO_OUTPUT="vol-plug-ms" && controlaudio stop
#[[ "$1" = "ms_off" && "$2" = "control_on"   ]] && AUDIO_OUTPUT="jack-bf" && controlaudio measure
#[[ "$1" = "ms_on"  && "$2" = "control_on"   ]] && AUDIO_OUTPUT="jack-bfms" && controlaudio measure

[ -e /tmp/measurement ] && controlaudio stop
[ -e /tmp/measurement ] && [[ "$MEASUREMENT_OUTPUT" = "jack-bf" || "$MEASUREMENT_OUTPUT" = "jack-bfms" ]] && controlaudio brutefir

[ -e /tmp/measurement ] && echo "Output is $MEASUREMENT_OUTPUT"
[ -e /tmp/measurement ] && echo "Stopped audio processing"

# Start the acquisition elsewhere, so we can kill it easier
[ -e /tmp/measurement ] && recordsweep_play_record "$MEASUREMENT_OUTPUT"

rm "$OUTFILE".1
mv "$OUTFILE".0 $OUTFILE
[ -e /tmp/measurement ] && echo "Measurement done!"
echo "Starting audio processing again..."
rm /tmp/measurement
sleep 1
#controlaudio stop &> /dev/null
#controlaudio start &> /dev/null
echo "Done!"
