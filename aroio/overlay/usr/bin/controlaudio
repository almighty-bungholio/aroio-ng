#!/bin/sh

. /boot/userconfig.txt

ACTION="$1"

echo "Controlaudio "$ACTION" ..."

[ "$SOUNDCARD" = "Internal HDMI audio" ] && amixer cset numid=3 2
[ "$SOUNDCARD" = "Internal audio jack" ] && amixer cset numid=3 1

function Start()
{

	sed -i "/#SAMPLINGRATE/c\        rate "$RATE" #SAMPLINGRATE" /etc/asound.conf
	sed -i "/defaults.pcm.rate_converter/c\defaults.pcm.rate_converter \"$RESAMPLING\"" /etc/asound.conf
	sed -i "/output_rate/c\output_rate = "$SPRATE""  /etc/shairport-sync.conf
	sed -i "/buffer_size/c\buffer_size = "$SP_OUTBUFFER""  /etc/shairport-sync.conf
#	sed -i "/period_size/c\period_size = "$SP_PERIOD""  /etc/shairport-sync.conf

	case "$AUDIO_OUTPUT" in
		vol-plug)
			case "$RAW_PLAYER" in
				squeezelite)
					systemctl "$ACTION" squeezelite.service
				;;

				gmediarender)
					systemctl "$ACTION" gmediarender.service
				;;

				shairportsync)
					systemctl "$ACTION" shairport-sync.service
				;;

				bluealsaaplay)
					systemctl "$ACTION" bluealsa-aplay.service
				;;
			esac
		;;

		vol-plug-ms)
			case "$RAW_PLAYERMS" in
				squeezelite)
					systemctl "$ACTION" squeezelite.service
				;;

				gmediarender)
					systemctl "$ACTION" gmediarender.service
				;;

				shairportsync)
					systemctl "$ACTION" shairport-sync.service
				;;

				bluealsaaplay)
					systemctl "$ACTION" bluealsa-aplay.service
				;;
			esac
		;;

		vol-plug-dmix)
			[ "$DMIX_SQUEEZELITE"   = "ON" ] && systemctl "$ACTION" squeezelite.service
			[ "$DMIX_GMEDIARENDER"  = "ON" ] && systemctl "$ACTION" gmediarender.service
			[ "$DMIX_SHAIRPORTSYNC" = "ON" ] && systemctl "$ACTION" shairport-sync.service
			[ "$DMIX_BLUEALSAAPLAY" = "ON" ] && systemctl "$ACTION" bluealsa-aplay.service
		;;

		vol-plug-dmix-ms)
			[ "$DMIXMS_SQUEEZELITE"   = "ON" ] && systemctl "$ACTION" squeezelite.service
			[ "$DMIXMS_GMEDIARENDER"  = "ON" ] && systemctl "$ACTION" gmediarender.service
			[ "$DMIXMS_SHAIRPORTSYNC" = "ON" ] && systemctl "$ACTION" shairport-sync.service
			[ "$DMIXMS_BLUEALSAAPLAY" = "ON" ] && systemctl "$ACTION" bluealsa-aplay.service
		;;

		jack)
			systemctl "$ACTION" jackd.service
			until jack_lsp | grep jackmixer ; do sleep 0.1 ; done
			sleep 1
			[[ "$JACK_NETJACK"      = "ON"  && "$ACTION" != "stop" ]] && echo "netmanager start" && jack_load netmanager && connect_netjackports
			[ "$JACK_SQUEEZELITE"   = "ON" ] && systemctl "$ACTION" squeezelite.service
			[ "$JACK_GMEDIARENDER"  = "ON" ] && systemctl "$ACTION" gmediarender.service
			[ "$JACK_SHAIRPORTSYNC" = "ON" ] && systemctl "$ACTION" shairport-sync.service
			[ "$JACK_BLUEALSAAPLAY" = "ON" ] && systemctl "$ACTION" bluealsa-aplay.service
			[ "$JACK_INPUT" = "ON" ] && sleep 0.2 && jack_connect system:capture_1 system:playback_1 && jack_connect system:capture_2 system:playback_2
		;;

		jack-ms)
			systemctl "$ACTION" jackd.service
			until jack_lsp | grep jackmixer ; do sleep 0.1 ; done
			[[ "$JACKMS_NETJACK"      = "ON"  && "$ACTION" != "stop" ]] &&  jack_load netmanager && connect_netjackports
			[ "$JACKMS_SQUEEZELITE"   = "ON" ] && systemctl "$ACTION" squeezelite.service
			[ "$JACKMS_GMEDIARENDER"  = "ON" ] && systemctl "$ACTION" gmediarender.service
			[ "$JACKMS_SHAIRPORTSYNC" = "ON" ] && systemctl "$ACTION" shairport-sync.service
			[ "$JACKMS_BLUEALSAAPLAY" = "ON" ] && systemctl "$ACTION" bluealsa-aplay.service
			[ "$JACKMS_INPUT" = "ON" ] && sleep 0.2 && jack_connect system:capture_1 system:playback_1 && jack_connect system:capture_2 system:playback_2
		;;

		jack-bf)
			systemctl "$ACTION" jackd.service
			until jack_lsp | grep jackmixer ; do sleep 0.1 ; done
			systemctl "$ACTION" brutefir.service
			until jack_lsp | grep brutefir ; do sleep 0.2 ; done
			[[ "$JACKBF_NETJACK"      = "ON"  && "$ACTION" != "stop" ]] && jack_load netmanager && connect_netjackports
			[ "$JACKBF_SQUEEZELITE"   = "ON" ] && systemctl "$ACTION" squeezelite.service
			[ "$JACKBF_GMEDIARENDER"  = "ON" ] && systemctl "$ACTION" gmediarender.service
			[ "$JACKBF_SHAIRPORTSYNC" = "ON" ] && systemctl "$ACTION" shairport-sync.service
			[ "$JACKBF_BLUEALSAAPLAY" = "ON" ] && systemctl "$ACTION" bluealsa-aplay.service
			[ "$JACKBF_INPUT" = "ON" ] && sleep 0.2 && jack_connect system:capture_1 brutefir:input-0 && jack_connect system:capture_2 brutefir:input-1
		;;

		jack-bfms)
			systemctl "$ACTION" jackd.service
			until jack_lsp | grep jackmixer ; do sleep 0.1 ; done
			systemctl "$ACTION" brutefir.service
			until jack_lsp | grep brutefir ; do sleep 0.2 ; done
			[[ "$JACKBFMS_NETJACK"      = "ON"  && "$ACTION" != "stop" ]] && jack_load netmanager && connect_netjackports
			[ "$JACKBFMS_SQUEEZELITE"   = "ON" ] && systemctl "$ACTION" squeezelite.service
			[ "$JACKBFMS_GMEDIARENDER"  = "ON" ] && systemctl "$ACTION" gmediarender.service
			[ "$JACKBFMS_SHAIRPORTSYNC" = "ON" ] && systemctl "$ACTION" shairport-sync.service
			[ "$JACKBFMS_BLUEALSAAPLAY" = "ON" ] && systemctl "$ACTION" bluealsa-aplay.service
			[ "$JACKBFMS_INPUT" = "ON" ] && jack_connect system:capture_1 brutefir:input-0 && jack_connect system:capture_2 brutefir:input-1
		;;
	esac
}

function StopStatus()
{
	[ "$1" = "stop" ] && volumecontrol -120 && sleep 0.5 && killall jack_persistent_client
	for SERVICE in squeezelite gmediarender shairport-sync bluealsa-aplay brutefir jackd
	do
		systemctl "$1" "$SERVICE".service
	done
}

function Measure()
{
	for SERVICE in squeezelite gmediarender shairport-sync bluealsa-aplay
	do
		systemctl "$1" "$SERVICE".service
	done
}

case "$ACTION" in
	stop|status)
	StopStatus "$ACTION"
	;;

	start)
	Start
	;;

	restart)
	StopStatus stop
	Start
	;;

	measure)
	Measure stop
	;;
esac

exit 0
